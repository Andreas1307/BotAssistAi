<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Redirecting…</title>
</head>
<body style="text-align:center;margin-top:30vh;font-family:sans-serif">
  <h3>Redirecting…</h3>
  <script>
    const params = new URLSearchParams(location.search);
    const shop = params.get("shop");
    const host = params.get("host");
    const target = params.get("target");

    if (target) {
      const decoded = decodeURIComponent(target);

      // ✅ Safe breakout logic
      if (decoded.includes("api.botassistai.com")) {
        // if inside Shopify admin iframe, use window.location not top
        if (window.top !== window.self) {
          window.location.assign(decoded);
        } else {
          window.location.replace(decoded);
        }
      } else {
        // For Shopify/admin URLs, safely open top frame
        window.top.location.replace(decoded);
      }
    } else if (shop) {
      const safeHost = host || btoa(`${shop}/admin`);
      window.top.location.replace(
        `https://${shop}/admin/apps/botassistai?shop=${shop}&host=${safeHost}`
      );
    } else {
      window.location.replace("https://botassistai.com/");
    }
  </script>
</body>
</html>
